<!DOCTYPE html>
<html lang="en">
<head>
  <title>Final Project</title>
    <!-- Juanito Clement Tanjung - 2001621611 -->
    <!--  Kenneth Wilson - 2001622476 -->
  <script type="text/javascript" src="babylon.custom.js"></script>
  <script type="text/javascript" src="FunctionCreateMatTex.js"></script>
  <link rel="stylesheet" type="text/css" href="Style.css">
  <meta charset="UTF-8">
</head>
<body>
  <canvas id="renderCanvas"></canvas>
  <script>
        var canvas = document.getElementById("renderCanvas");
        var engine = new BABYLON.Engine(canvas, true);
        var boy;
        var miku;
        var mikuHeads=[];
        var mikuBodies=[];
        var jetpack;
        var coin;
        var coins=[];
        var ground;
        var material;
        var coinSpawned;
        var mikuSpawned;
        var count=0;
        var run;
        var paused=false;
        document.addEventListener("DOMContentLoaded", function()
        {
          window.alert('Play the game');
          // var material = createMatTex(scene);
          // gravity = new BABYLON.Vector3(0, -9.81, 0);
          // physicsEngine = new BABYLON.CannonJSPlugin();
          // scene.enablePhysics(gravity, physicsEngine);

        });
        var createScene = function () {
            var scene = new BABYLON.Scene(engine);
            //Adding a light
            var light = new BABYLON.PointLight("Omni", new BABYLON.Vector3(20, 20, 100), scene);
            material = createMatTex(scene);
            ground = new BABYLON.Mesh.CreateGround("ground",1000, 1000, 1, scene);
            ground.material = material;
            //Adding an Arc Rotate Camera (camera variable,sideways rotation, upwards/downwards rotation,distance )
            var camera = new BABYLON.ArcRotateCamera("Camera", 300, 1, 450, BABYLON.Vector3.Zero(), scene);
            camera.attachControl(canvas, false);
            // Move the light with the camera
            scene.registerBeforeRender(function () {
                light.position = camera.position;
            });
            var rightwall = BABYLON.MeshBuilder.CreateBox("rightwall", {height: 500, width: 1, depth: 1000}, scene);
            rightwall.position.y = 250;
            rightwall.position.x = 500;

            var leftwall = BABYLON.MeshBuilder.CreateBox("leftwall", {height: 500, width: 1, depth: 1000}, scene);
            leftwall.position.y = 250;
            leftwall.position.x = -500;

            var topwall = BABYLON.MeshBuilder.CreateBox("topwall", {height: 1, width: 1000, depth: 1000}, scene);
            topwall.position.y = 500;
            topwall.position.x = 0;
            var music = new BABYLON.Sound("radionoise", "music/radionoise.wav", scene, null, { loop: true, autoplay: true });
            BABYLON.SceneLoader.ImportMesh("", "scenes/boy/", "character-male-muscle.babylon", scene,
            function (newMeshes2) {
              boy = newMeshes2[3];
              boy.name = "boy";
              camera.lockedTarget = newMeshes2[3];
              boy.scaling = new BABYLON.Vector3(0.4,0.4,0.4);
              boy.position.x = 100;
              boy.position.y = 30;
              boy.position.z =-500;
              moveRight = function ()
              {
                boy.position.x += 10;
              }
              moveLeft = function ()
              {
                boy.position.x =   boy.position.x - 10;
              }
              moveUp = function ()
              {
                boy.position.y =   boy.position.y - 10;
              }
              moveDown = function ()
              {
                boy.position.y += 10;
              }
              moveForward = function ()
              {
                boy.position.z += 1;
                rightwall.position.z += 1;
                leftwall.position.z += 1;
                topwall.position.z += 1;
                ground.position.z += 1;
              }
              getBoy = function()
              {
                return boy;
              }
              getX = function()
              {
                return boy.position.x;
              }
              getY = function()
              {
                return boy.position.y;
              }
              getZ = function()
              {
                return boy.position.z;
              }
            },
            );
            BABYLON.SceneLoader.ImportMesh("", "scenes/coin/", "coin.babylon", scene, function (newCoin) {
                newCoin[0].position.y =100000;
                spawnCoin = function(minimumZ)
                {
                  coinSpawned = newCoin[0].clone();
                  coinSpawned.scaling = new BABYLON.Vector3(4,4,4);
                  coinSpawned.position = new BABYLON.Vector3(
                                        Math.floor(Math.random() * 1000)-500,         //positionnya bakal diganti kalo map nya uda jdi
                                        Math.floor(Math.random() * 500),
                                        Math.floor(Math.random() * 1000)+minimumZ
                                      );
                  coins.push(coinSpawned);
                }
                startcoinSpinAnimation = function()
                {
                  coins.forEach(
                      function(spinnedCoin){
                        spinnedCoin.addRotation(0,0.15,0);
                      }
                  );
                }
                destroyPassedCoins = function(boyZposition)
                {
                  coins.forEach(
                      function(spinnedCoin){
                        if(spinnedCoin.position.z + 500 < boyZposition)
                        {
                          coins.splice(coins.indexOf(spinnedCoin),1);
                          spinnedCoin.dispose();
                        }
                      }
                  );
                }
                collisionCoin = function(boy)
                {
                  coins.forEach(
                    function(coinSpawned){
                      if(coinSpawned.intersectsMesh(boy,true))
                      {
                        console.log("colliding. removing from array length: "+ coins.length )
                        coins.splice(coins.indexOf(coinSpawned),1);
                        coinSpawned.dispose();
                        console.log("removed. length: "+ coins.length);
                        count= count+1;
                        scoreTxt.text = "Coins : " + count;
                      }
                    }
                  );
                }
            });
            BABYLON.SceneLoader.ImportMesh("", "scenes/jetpack/", "jetpack.babylon", scene,
              function (newMeshes) {
                  jetpack = newMeshes[0];
                  jetpack.scaling = new BABYLON.Vector3(1.8,1.8,1.8);
                  jetpack.addRotation(-Math.PI/2,Math.PI/2,Math.PI/2);

                  setJetPackPosition = function (x,y,z) {
                    jetpack.position.x = x;
                    jetpack.position.y = y+ 95;
                    jetpack.position.z = z + -20;
                  }
                }
            );
            BABYLON.SceneLoader.ImportMesh("", "scenes/Miku/", "miku.babylon", scene,
              function (newMeshes) {
                  var size = newMeshes[0].getBoundingInfo().boundingBox.extendSize;
                  var maxX = 500 - (20 * size.x);
                  var minX = -500 + (20 * size.x);
                  var maxY = 500 - (10*size.y);
                  var minY = 25*size.y;
                  newMeshes[0].position.y=10000;
                  newMeshes[1].position.y=10000;
               spawnMiku = function(boyZposition){
                  mikuHeadSpawned = newMeshes[0].clone();
                  mikuBodySpawned = newMeshes[1].clone();
                  mikuHeadSpawned.scaling = new BABYLON.Vector3(10,10,10);
                  mikuBodySpawned.scaling = new BABYLON.Vector3(10,10,10);
                  var randomMikuXPosition = Math.floor(Math.random() * (maxX-minX) + minX);
                  var randomMikuYposition = Math.floor(Math.random() * (maxY-minY) + minY);
                  var randomMikuZPosition = Math.floor(Math.random() * 1000)+300 +boyZposition;
                  mikuHeadSpawned.position = new BABYLON.Vector3(
                                        randomMikuXPosition,         //positionnya bakal diganti kalo map nya uda jdi
                                        randomMikuYposition,
                                        randomMikuZPosition
                                      );
                  mikuBodySpawned.position = new BABYLON.Vector3(
                                        randomMikuXPosition+50,
                                        randomMikuYposition-35,
                                        randomMikuZPosition-15
                                      );
                  mikuHeads.push(mikuHeadSpawned);
                  mikuBodies.push(mikuBodySpawned);
               }
                startMikuSpinAnimation = function()
                {
                  mikuHeads.forEach(
                      function(spinningMiku){
                        spinningMiku.setPivotMatrix(BABYLON.Matrix.Translation(8, 0, 0));
                        spinningMiku.addRotation(0,0.1,0);
                      }
                  );
                }
                destroyPassedMikus = function(boyZposition)
                {
                  mikuHeads.forEach(
                      function(miku){
                        if(miku.position.z + 500< boyZposition)
                        {
                          mikuHeads.splice(mikuHeads.indexOf(miku),1);
                          miku.dispose();
                        }
                      }
                  );
                  mikuBodies.forEach(
                    function(miku)
                    {
                      if(miku.position.z + 500< boyZposition)
                      {
                        mikuBodies.splice(mikuBodies.indexOf(miku),1);
                        miku.dispose();
                      }
                    }
                  );

                }
                collisionMiku = function(boy)
                {
                  mikuHeads.forEach(
                    function(mikuSpawned){
                      if(mikuSpawned.intersectsMesh(boy,true))
                      {
                        var index=mikuHeads.indexOf(mikuSpawned)
                        mikuBodies[index].dispose();
                        mikuSpawned.dispose();
                        mikuHeads.splice(index,1);
                        mikuBodies.splice(index,1);
                      }
                    }
                  );

                }
              }
            );

          // spawn coin. working. tpi gua comment soalnya rusuh
         setInterval(function(){
            spawnCoin(boy.position.z);
          }, Math.floor(Math.random()*5000)+5000); //spawn random between 5s to 10s

         setInterval(function(){
            spawnMiku(boy.position.z);
          }, Math.floor(Math.random()*5000)+3000); //spawn random between 3s to 8s
            // GUI Button
            var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI('UI', undefined, undefined, BABYLON.Texture.NEAREST_NEAREST);
            var exitBtn = BABYLON.GUI.Button.CreateSimpleButton("exitBtn", 'Exit');
            exitBtn.width = '250px';
            exitBtn.height = '30px';
            exitBtn.color = "black";
            exitBtn.fontSize = 20;
            exitBtn.thickness = 0;
            exitBtn.background = "white";
            advancedTexture.addControl(exitBtn);
            exitBtn.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
            exitBtn.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
            // GUI Score
            var scoreTxt = new BABYLON.GUI.TextBlock();
            scoreTxt.text = "Coins : " + count;
            scoreTxt.color = "blue";
            scoreTxt.fontSize = 24;
            advancedTexture.addControl(scoreTxt);
            scoreTxt.textVerticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
            scoreTxt.textHorizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
          return scene;
        }

        var scene = createScene();



          engine.runRenderLoop(run = function () {
          // scene.fogMode = BABYLON.Scene.FOGMODE_EXP;
          // scene.fogDensity = 0.0015;
            if (scene && paused==false) {
              moveForward();
              setJetPackPosition(getX(),getY(),getZ());
              startcoinSpinAnimation();
              startMikuSpinAnimation();
              destroyPassedCoins(getZ());
              collisionCoin(getBoy());
              destroyPassedMikus(getZ());
              collisionMiku(getBoy());
              var count=0;

              window.onkeydown = function(event){
                if(event.keyCode==65){ //A
                  moveLeft();
                }
                else if(event.keyCode==68){ //D
                  moveRight();
                }
                else if(event.keyCode==83){ //S
                  moveUp();
                }
                else if(event.keyCode==87){ //W
                  moveDown();
                }
                else if(event.keyCode==80 && paused==false){
                  paused=true;
                  engine.stopRenderLoop();
                  console.log(paused);
                  window.alert('Paused Press P to Continue');
                }
                else if(event.keyCode == 80&& paused==true){
                  paused=false;
                  engine.runRenderLoop(function() {run()} );
                  console.log(paused);
                }
              }
                scene.render();
            }
        });

        // Resize
        window.addEventListener("resize", function () {
            engine.resize();
        });
    </script>
  </body>
</html>
